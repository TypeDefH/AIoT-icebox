<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>移动制冷设备控制</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#36B37E',
            warning: '#FF9F43',
            danger: '#F55661',
            info: '#4A90E2',
            dark: '#2D3748',
          }
        }
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .card-shadow { box-shadow: 0 4px 12px rgba(0,0,0,0.08); transition: all 0.3s ease; }
      .card-shadow:hover { box-shadow: 0 8px 24px rgba(0,0,0,0.12); transform: translateY(-4px); }
      .btn-toggle { @apply relative w-14 h-7 rounded-full transition-all duration-300 ease-in-out cursor-pointer; }
      .btn-toggle::after { content: ''; @apply absolute left-1 top-1 w-5 h-5 bg-white rounded-full transition-transform duration-300 ease-in-out shadow-md; }
      .btn-toggle.on { @apply bg-secondary; }
      .btn-toggle.on::after { @apply transform translate-x-7; }
      .btn-toggle.off { @apply bg-gray-300; }
      .history-tab { @apply transition-all duration-300 ease-in-out cursor-pointer; }
      .section-fade { @apply opacity-0 translate-y-4 animate-[fadeInUp_0.6s_ease-out_forwards]; }
      .realtime-badge { @apply absolute top-3 right-3 px-2 py-0.5 text-xs rounded-full bg-primary/10 text-primary; }
      @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
      @keyframes pulse { 0%,100%{opacity:1;}50%{opacity:0.6;} }
      .pulse-animation { animation: pulse 2s infinite; }
      .loading-spinner { @apply inline-block w-4 h-4 border-2 border-primary border-t-transparent rounded-full animate-spin; }
    }
  </style>
</head>
<body class="bg-gray-50 text-dark min-h-screen">

<header class="bg-gradient-to-r from-primary to-info shadow-md py-8 relative overflow-hidden">
  <div class="container mx-auto px-4 relative z-10">
    <h1 class="text-[clamp(1.8rem,3vw,2.5rem)] font-bold text-white text-center tracking-wide">
      移动制冷设备控制
    </h1>
    <p class="text-blue-100 text-center mt-2 opacity-90">
      <span id="connectionStatus" class="flex items-center justify-center">
        <i class="fa fa-circle text-xs mr-1"></i>
        <span>连接状态：加载中</span>
      </span>
    </p>
  </div>
</header>

<main class="container mx-auto px-4 py-10">
  <section class="mb-14 section-fade" style="animation-delay: 0.1s">
    <div class="flex items-center mb-6">
      <i class="fa fa-dashboard text-primary mr-3 text-xl"></i>
      <h2 class="text-xl font-semibold text-gray-800">实时数据</h2>
    </div>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
      <div class="bg-white rounded-xl p-6 card-shadow border-t-4 border-warning relative">
        <span class="realtime-badge">实时</span>
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-gray-600 font-medium">温度</h3>
          <i class="fa fa-thermometer-half text-warning text-xl"></i>
        </div>
        <div class="text-3xl font-bold text-gray-800" id="temperature">--°C</div>
      </div>

      <div class="bg-white rounded-xl p-6 card-shadow border-t-4 border-info relative">
        <span class="realtime-badge">实时</span>
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-gray-600 font-medium">湿度</h3>
          <i class="fa fa-tint text-info text-xl"></i>
        </div>
        <div class="text-3xl font-bold text-gray-800" id="humidity">--%</div>
      </div>

      <div class="bg-white rounded-xl p-6 card-shadow border-t-4 border-primary relative">
        <span class="realtime-badge">实时</span>
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-gray-600 font-medium">设备俯仰角</h3>
          <i class="fa fa-arrow-up text-primary text-xl"></i>
        </div>
        <div class="text-3xl font-bold text-gray-800" id="pitch">--°</div>
      </div>
      
      <div class="bg-white rounded-xl p-6 card-shadow border-t-4 border-info relative">
        <span class="realtime-badge">实时</span>
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-gray-600 font-medium">设备翻滚角</h3>
          <i class="fa fa-arrow-down text-info text-xl"></i>
        </div>
        <div class="text-3xl font-bold text-gray-800" id="roll">--°</div>
      </div>

      <div class="bg-white rounded-xl p-6 card-shadow border-t-4 border-secondary relative">
        <span class="realtime-badge">实时</span>
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-gray-600 font-medium">运行状态</h3>
          <i class="fa fa-power-off text-secondary text-xl"></i>
        </div>
        <div class="text-3xl font-bold text-gray-800" id="status">--</div>
      </div>
    </div>
  </section>

  <section class="mb-14 section-fade" style="animation-delay: 0.3s">
    <div class="flex items-center mb-6">
      <i class="fa fa-cogs text-primary mr-3 text-xl"></i>
      <h2 class="text-xl font-semibold text-gray-800">设备控制</h2>
    </div>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
      <div class="bg-white rounded-xl p-6 card-shadow border-l-4 border-secondary">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-gray-700 font-medium flex items-center">
              <i class="fa fa-power-off mr-2 text-secondary"></i> 开关
            </h3>
            <p class="text-sm text-gray-500" id="deviceSwitchStatus">加载中...</p>
          </div>
          <div class="btn-toggle off" id="deviceSwitchToggle"></div>
        </div>
      </div>
      <div class="bg-white rounded-xl p-6 card-shadow border-l-4 border-info">
      <div class="flex items-center justify-between">
        <div>
          <h3 class="text-gray-700 font-medium flex items-center">
            <i class="fa fa-lightbulb-o mr-2 text-info"></i> 制冷灯
          </h3>
        </div>
        <div class="btn-toggle off" id="ledSwitchToggle"></div>
      </div>
    </div>

      <div class="bg-white rounded-xl p-6 card-shadow border-l-4 border-warning">
        <div class="flex flex-col items-center justify-center gap-4">
          <h3 class="text-gray-700 font-medium flex items-center">
            <i class="fa fa-thermometer-half mr-2 text-warning"></i> 温度设置
          </h3>
          <input type="number" id="tempSetInput" min="16" max="30" step="0.5" value="24" class="border p-2 rounded text-center w-24">
          <button id="setTempBtn" class="px-4 py-2 bg-primary text-white rounded hover:bg-blue-600 transition-colors">设置温度</button>
        </div>
      </div>
    </div>
  </section>

  <section class="section-fade" style="animation-delay: 0.5s">
    <div class="flex items-center mb-6">
      <i class="fa fa-history text-primary mr-3 text-xl"></i>
      <h2 class="text-xl font-semibold text-gray-800">历史数据分析</h2>
    </div>
    <div class="flex flex-wrap gap-3 mb-6">
      <button class="history-tab px-4 py-2 rounded-lg bg-primary text-white" data-type="temp" data-name="温度" data-unit="°C" data-color="#FF9F43">温度</button>
      <button class="history-tab px-4 py-2 rounded-lg bg-gray-200 text-gray-700" data-type="humi" data-name="湿度" data-unit="%" data-color="#4A90E2">湿度</button>
      <button class="history-tab px-4 py-2 rounded-lg bg-gray-200 text-gray-700" data-type="pitch" data-name="俯仰角" data-unit="°" data-color="#165DFF">俯仰角</button>
      <button class="history-tab px-4 py-2 rounded-lg bg-gray-200 text-gray-700" data-type="roll" data-name="翻滚角" data-unit="°" data-color="#00D1DE">翻滚角</button>
    </div>
    <div class="bg-white rounded-xl p-6 card-shadow">
      <div class="flex justify-center items-center" id="historyChartLoader" style="height: 300px; display: none;">
        <div class="text-center">
          <div class="loading-spinner mx-auto mb-2"></div>
          <p class="text-gray-500">加载历史数据中...</p>
        </div>
      </div>
      <canvas id="historyChart" height="300"></canvas>
    </div>
  </section>
</main>

<footer class="bg-gray-800 text-white py-6 mt-12">
  <div class="container mx-auto px-4 text-center text-sm opacity-75">
    <p>移动制冷设备控制 &copy; 2025</p>
  </div>
</footer>

<script>
const SERVER_URL = window.location.origin;
let refreshInterval = null;

function updateConnectionStatus(isConnected, message="") {
  const statusElement = document.getElementById("connectionStatus");
  if(isConnected){
    statusElement.innerHTML = '<i class="fa fa-circle text-xs text-green-400 mr-1"></i><span>连接状态：已连接</span>';
  } else {
    statusElement.innerHTML = `<i class="fa fa-circle text-xs text-yellow-400 mr-1 pulse-animation"></i><span>连接状态：${message || "连接中"}</span>`;
  }
}

async function fetchRealtimeData(){
  try {
    const res = await fetch(`${SERVER_URL}/api/data`);
    if(!res.ok) throw new Error("网络响应错误");
    const data = await res.json();
    
    if(data.code === 0 && data.data) {
      updateConnectionStatus(true);
      updateUI(data.data);
    } else {
      updateConnectionStatus(false, data.msg || "数据异常");
    }
  } catch(e) {
    updateConnectionStatus(false, "后端连接失败");
  }
}

function updateUI(dataList){
  const map = {};
  if(Array.isArray(dataList)){
    dataList.forEach(item => map[item.identifier] = item.value);
  }

  // led 制冷灯回显
  if(map.led !== undefined) {
    const isLedOn = parseInt(map.led) === 1;
    const ledToggle = document.getElementById("ledSwitchToggle");
    ledToggle.classList.remove("on", "off");
    ledToggle.classList.add(isLedOn ? "on" : "off");
  }

  if(map.temp !== undefined) document.getElementById("temperature").textContent = parseFloat(map.temp).toFixed(1)+"°C";
  if(map.humi !== undefined) document.getElementById("humidity").textContent = parseFloat(map.humi).toFixed(0)+"%";
  if(map.pitch !== undefined) document.getElementById("pitch").textContent = parseFloat(map.pitch).toFixed(1)+"°";
  
  // 翻滚角处理
  if(map.roll !== undefined) {
    const rollVal = parseFloat(map.roll);
    document.getElementById("roll").textContent = rollVal.toFixed(1)+"°";
    
    //滚转角小于 40 度是开启状态
    const isRunning = Math.abs(rollVal) < 40; 
    const statusText = isRunning ? "开启" : "关闭";
    
    document.getElementById("status").textContent = statusText;
    document.getElementById("deviceSwitchStatus").textContent = statusText;
    
    const toggle = document.getElementById("deviceSwitchToggle");
    toggle.classList.remove("on", "off");
    toggle.classList.add(isRunning ? "on" : "off");
  }
}

// 通用控制函数，增加健壮的 JSON 解析
async function sendControl(params) {
  try {
    updateConnectionStatus(false, "下发指令...");
    const res = await fetch(`${SERVER_URL}/api/control`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(params)
    });

    const contentType = res.headers.get("content-type");
    if (res.ok && contentType && contentType.includes("application/json")) {
      const result = await res.json();
      if (result.code === 0) {
        setTimeout(fetchRealtimeData, 1000); 
        return true;
      }
    } else if (res.ok) {
      // 如果返回的是成功但不是 JSON
      setTimeout(fetchRealtimeData, 1000);
      return true;
    }
    throw new Error("指令响应异常");
  } catch(e) {
    alert("操作失败：" + e.message);
    return false;
  }
}

document.getElementById("deviceSwitchToggle").addEventListener("click", () => {
  const isCurrentlyOn = document.getElementById("deviceSwitchToggle").classList.contains("on");
  sendControl({ relay: isCurrentlyOn ? 0 : 1 });
});

document.getElementById("ledSwitchToggle").addEventListener("click", function() {
  const isCurrentlyOn = this.classList.contains("on");
  const nextStatus = isCurrentlyOn ? 0 : 1;
  
  // 调用 API，发送 led 参数
  sendControl({ led: nextStatus });
  
  // 乐观 UI 更新：先切换样式，等 1 秒后再刷真实数据
  this.classList.toggle('on');
  this.classList.toggle('off');
});

document.getElementById("setTempBtn").addEventListener("click", () => {
  const val = parseFloat(document.getElementById("tempSetInput").value);
  if(val >= 16 && val <= 30) {
    sendControl({ temp: val }).then(success => {
      if(success) alert("温度设置成功");
    });
  } else {
    alert("请输入16~30°C之间的数值");
  }
});

// 定时器管理
function startAutoRefresh() {
  if (!refreshInterval) {
    refreshInterval = setInterval(() => {
      if (!document.hidden) fetchRealtimeData();
    }, 10000);
  }
}

function stopAutoRefresh() {
  clearInterval(refreshInterval);
  refreshInterval = null;
}

document.addEventListener("visibilitychange", () => {
  document.hidden ? stopAutoRefresh() : (fetchRealtimeData(), startAutoRefresh());
});

// 历史数据逻辑保持不变
let historyChart = null;
function initHistoryChart(labels, data, label, color){
  const ctx = document.getElementById("historyChart").getContext("2d");
  if(historyChart) historyChart.destroy();
  historyChart = new Chart(ctx, {
    type: "line",
    data: {
      labels: labels,
      datasets: [{
        label: label,
        data: data,
        borderColor: color,
        backgroundColor: color + "33",
        fill: true,
        tension: 0.4,
        pointBackgroundColor: color,
        pointRadius: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { intersect: false, mode: 'index' }
    }
  });
  document.getElementById("historyChartLoader").style.display = "none";
  document.getElementById("historyChart").style.display = "block";
}

document.querySelectorAll(".history-tab").forEach(tab => {
  tab.addEventListener("click", async () => {
    document.querySelectorAll(".history-tab").forEach(t => { 
      t.classList.remove("bg-primary", "text-white"); 
      t.classList.add("bg-gray-200", "text-gray-700");
    });
    tab.classList.remove("bg-gray-200", "text-gray-700"); 
    tab.classList.add("bg-primary", "text-white");

    const { type, name, unit, color } = tab.dataset;
    document.getElementById("historyChartLoader").style.display = "flex";
    document.getElementById("historyChart").style.display = "none";

    try {
      const res = await fetch(`${SERVER_URL}/api/history?identifier=${type}`);
      if(res.ok) {
        const result = await res.json();
        if (result.data && result.data.list) {
          const historyList = result.data.list.reverse();
          const labels = historyList.map(item => {
            const d = new Date(item.time);
            return `${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
          });
          const values = historyList.map(item => parseFloat(item.value));
          initHistoryChart(labels, values, `${name}${unit ? "(" + unit + ")" : ""}`, color);
        }
      }
    } catch (e) { console.error(e); }
  });
});

window.addEventListener("load", () => {
  fetchRealtimeData();
  startAutoRefresh();
  document.querySelector('.history-tab[data-type="temp"]').click();
});
</script>
</body>
</html>